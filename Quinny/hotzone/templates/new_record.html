{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block content %}
<h1>New Record</h1>
<br><br>

Search: <input type="text" id="keyword" placeholder="Type Keywords">
<p>(Please scroll down to see the list of search result after typing)</p>
<p>(After selecting the search result, the following forms will be automatically populated)</p>
<br>
<form method="POST" class="post-form">
	{% csrf_token %}
	{{ form.as_p }}
	<button type="submit" class="save btn btn-dark">Save Location</button>
</form>
<br><br><br>
<span id="result" class="table-responsive">
</span>


{% endblock %}


{% block javascript %}
<script>
	function load_onclick() {
		$(".table").on("click", "tr", function(){
			$("#id_x").val($(':nth-child(1)', this).text());
			$("#id_y").val($(':nth-child(2)', this).text());
			$("#id_name").val($(':nth-child(3)', this).text());
			$("#id_address").val($(':nth-child(4)', this).text());
		});
	};
	function no_result() {
		var table = $('<table border=1 class="table table-striped table-bordered table-dark" id="result-table"><tr> <th colspan="4">Search Results </th></tr>');
		var tblHeader = "<tr><th>X</th><th>Y</th><th>Name</th><th>Address</th></tr>";
		tblHeader += "<tr><td colspan='4' style='text-align:center;'> No Result </td></tr></table>"
		$('#result-table').remove();
		$(tblHeader).appendTo(table);
		$(table).appendTo('#result');
	}
	$(function() {
		var typingTimer; //timer identifier
		var doneTypingInterval = 500; //time in ms, 5 second for example
		var $input = $('#keyword');

		//on keyup, start the countdown
		$input.on('keyup', function() {
			clearTimeout(typingTimer);
			typingTimer = setTimeout(doneTyping, doneTypingInterval);
		});

		//on keydown, clear the countdown
		$input.on('keydown', function() {
			clearTimeout(typingTimer);
		});

		//user is "finished typing," do something
		function doneTyping() {
			var objXMLHttpRequest = new XMLHttpRequest();
			objXMLHttpRequest.onreadystatechange = function() {
				if (objXMLHttpRequest.readyState === 4) {
					if (objXMLHttpRequest.status === 200) {
						// alert(objXMLHttpRequest.responseText);
						var response = jQuery.parseJSON(objXMLHttpRequest.responseText);
						if (typeof response == 'object') {
							// alert("it's json")
							var table = $('<table border=1 class="table table-striped table-bordered table-dark" id="result-table"><tr> <th colspan="4">Search Results (Click to select)</th></tr>');
							var tblHeader = "<tr><th>X</th><th>Y</th><th>Name</th><th>Address</th></tr>";
							// for (var k in response[0])
							// 	if (k == "x" || k == "y") tblHeader += "<th>" + k.toUpperCase() + "</th>"
							// 	else if (k == "addressEN") tblHeader += "<th> " + "Address" + "</th>"
							// 	else if (k == "nameEN") tblHeader += "<th> " + "Name" + "</th>"
							// tblHeader += "</tr>";
							$(tblHeader).appendTo(table);
							$.each(response, function(index, value) {
								var TableRow = "<tr class=q>";
								$.each(value, function(key, val) {
									if (key == "x" || key == "y" || key == "addressEN" || key == "nameEN")
										TableRow += "<td>" + val + "</td>";
								});
								TableRow += "</tr>";
								$(table).append(TableRow);
							});
							$('#result-table').remove();
							$(table).appendTo('#result');
							load_onclick();
						} else {
							if (response === false) {
								// the response was a string "false", parseJSON will convert it to boolean false
								no_result();

							} else {
								// the response was something else
								no_result();

							}
						}
					} else {
						no_result();
					}
				}
			}
			objXMLHttpRequest.open('GET', 'https://geodata.gov.hk/gs/api/v1.0.0/locationSearch?q=' + $input.val());
			objXMLHttpRequest.send();

		}
	});
</script>
{% endblock %}
